<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="theme-color" content="#f5f7fa" />
    <title>PoolController</title>
    <link rel="icon" href="/favicon.ico" sizes="any">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">

    <script src="/chart.umd.min.js"></script>
    <link rel="stylesheet" href="/app.css" />
    <script>
      // Vérifier l'authentification avant de charger l'app
      const token = sessionStorage.getItem('authToken');
      if (!token) {
        window.location.href = '/login.html';
      }

      // Nettoyer le token de l'URL (si présent après login)
      if (window.location.search.includes('token=')) {
        // Remplacer l'URL sans token dans l'historique
        const url = new URL(window.location.href);
        url.searchParams.delete('token');
        window.history.replaceState({}, document.title, url.pathname + url.hash);
      }
    </script>
    <script defer src="/app.js"></script>
  </head>

  <body>
    <div class="app">
      <!-- Sidebar -->
      <aside class="sidebar" aria-label="Navigation">
        <button class="burgerBtn" id="burger" type="button" aria-label="Fermer le menu">✕</button>

        <div class="brand">
          <img src="/android-chrome-192x192.png" alt="PoolController" class="brand__logo" />
          <div class="brand__text">
            <div class="brand__name">PoolController</div>
            <div class="brand__sub">
              <span class="status__dot" id="net-dot" aria-hidden="true"></span>
              <span class="status__text" id="net-text">Connexion…</span>
            </div>
          </div>
        </div>

        <div class="nav__separator"></div>

        <nav class="nav">
          <a class="nav__item" href="#/dashboard" data-route="/dashboard">
            <span class="nav__icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
            </span>
            <span class="nav__label">Tableau de bord</span>
          </a>

          <a class="nav__item" href="#/filtration" data-route="/filtration">
            <span class="nav__icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  aria-label="Pompe" role="img">
                <!-- Corps de pompe -->
                <rect x="7" y="9" width="10" height="8" rx="2"/>
                <!-- Moteur (à gauche) -->
                <rect x="3" y="10" width="4" height="6" rx="1.5"/>
                <!-- Bride/rotor -->
                <circle cx="12" cy="13" r="1.5"/>
                <!-- Sortie (à droite) -->
                <path d="M17 11h3v4h-3"/>
                <!-- Base -->
                <path d="M6 18h12"/>
              </svg>
            </span>
            <span class="nav__label">Filtration</span>
          </a>

          <a class="nav__item" href="#/lighting" data-route="/lighting">
            <span class="nav__icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
            </span>
            <span class="nav__label">Éclairage</span>
          </a>

          <a class="nav__item" href="#/temperature" data-route="/temperature">
            <span class="nav__icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"/></svg>
            </span>
            <span class="nav__label">Température</span>
          </a>

          <a class="nav__item" href="#/ph" data-route="/ph">
            <span class="nav__icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/>
                <text x="12" y="16" text-anchor="middle" font-size="6" font-weight="600" fill="currentColor" stroke="none">PH</text>
              </svg>
            </span>
            <span class="nav__label">pH</span>
          </a>

          <a class="nav__item" href="#/orp" data-route="/orp">
            <span class="nav__icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <!-- Éclair -->
                <path d="M13 2L3 14h8l-1 8 10-12h-8l1-8z"/>
              </svg>
            </span>
            <span class="nav__label">ORP</span>
          </a>

          <a class="nav__item" href="#/dosages" data-route="/dosages">
            <span class="nav__icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"/></svg>
            </span>
            <span class="nav__label">Dosages</span>
          </a>

          <a class="nav__item" href="#/settings" data-route="/settings">
            <span class="nav__icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6m-6-6h6m6 0h-6M4.22 4.22l4.24 4.24m7.08 7.08l4.24 4.24M19.78 4.22l-4.24 4.24m-7.08 7.08L4.22 19.78"/></svg>
            </span>
            <span class="nav__label">Paramètres</span>
          </a>

          <div class="nav__separator"></div>

          <a class="nav__item nav__item--logout" href="#" id="logout-btn">
            <span class="nav__icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                <polyline points="16 17 21 12 16 7"/>
                <line x1="21" y1="12" x2="9" y2="12"/>
              </svg>
            </span>
            <span class="nav__label">Déconnexion</span>
          </a>
        </nav>
      </aside>

      <!-- Main -->
      <main class="main">
        <!-- Mobile burger button -->
        <button class="burgerBtn burgerBtn--open" id="burger-open" type="button" aria-label="Ouvrir le menu">☰</button>

        <!-- Dashboard View -->
        <section class="view is-active" id="view-dashboard" data-view="/dashboard">
          <div class="settingsHead">
            <div class="settingsHead__title">Tableau de bord</div>
            <div class="settingsHead__sub">Vue d'ensemble de votre piscine</div>
          </div>

          <div class="chip" id="calib-chip" style="display:none;">
            <span class="chip__dot" aria-hidden="true"></span>
            Calibration nécessaire
          </div>

          <!-- Zone d'alertes -->
          <div id="alerts-container" class="alerts"></div>

          <!-- Cartes principales -->
          <div class="grid grid--status-cards">
            <!-- Carte Filtration -->
            <div class="card card--status">
              <div class="card__status-header">
                <div class="card__status-icon">
                  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="7" y="9" width="10" height="8" rx="2"/>
                    <rect x="3" y="10" width="4" height="6" rx="1.5"/>
                    <circle cx="12" cy="13" r="1.5"/>
                    <path d="M17 11h3v4h-3"/>
                    <path d="M6 18h12"/>
                  </svg>
                </div>
                <div class="card__status-info">
                  <div class="card__status-label">Filtration</div>
                  <div class="card__status-value" id="filtration-temp">--</div>
                </div>
              </div>
              <div class="card__status-body">
                <div class="card__status-trend" id="filtration-trend">
                  <span class="trend-arrow">→</span>
                  <span class="trend-text">Stable</span>
                </div>
                <div class="card__status-state" id="filtration-state">
                  <span class="state-badge state-badge--ok">Auto</span>
                </div>
                <div class="card__status-updated" id="filtration-updated">Dernière MAJ : --:--</div>
              </div>
            </div>

            <!-- Carte Éclairage -->
            <div class="card card--status">
              <div class="card__status-header">
                <div class="card__status-icon">
                  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="5"/>
                    <line x1="12" y1="1" x2="12" y2="3"/>
                    <line x1="12" y1="21" x2="12" y2="23"/>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                    <line x1="1" y1="12" x2="3" y2="12"/>
                    <line x1="21" y1="12" x2="23" y2="12"/>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                  </svg>
                </div>
                <div class="card__status-info">
                  <div class="card__status-label">Éclairage</div>
                  <div class="card__status-value" id="lighting-value">--</div>
                </div>
              </div>
              <div class="card__status-body">
                <div class="card__status-state" id="lighting-state">
                  <span class="state-badge state-badge--off">Éteint</span>
                </div>
                <div class="card__status-updated">Dernière MAJ : <span id="m-time">--:--</span></div>
              </div>
            </div>

            <!-- Carte pH compact -->
            <div class="card card--status card--compact">
              <div class="card__status-compact">
                <div class="compact-label">pH</div>
                <div class="compact-value" id="compact-ph">--</div>
                <div class="compact-target">Cible: <span id="compact-ph-target">7.2</span></div>
              </div>
            </div>

            <!-- Carte ORP compact -->
            <div class="card card--status card--compact">
              <div class="card__status-compact">
                <div class="compact-label">ORP</div>
                <div class="compact-value" id="compact-orp">--<span class="compact-unit">mV</span></div>
                <div class="compact-target">Cible: <span id="compact-orp-target">650</span> mV</div>
              </div>
            </div>
          </div>

          <!-- Graphique avec onglets -->
          <div class="card card--chart-tabs">
            <div class="card__head">
              <div class="chart-tabs">
                <button class="chart-tab chart-tab--active" data-chart="temperature">Température</button>
                <button class="chart-tab" data-chart="ph">pH</button>
                <button class="chart-tab" data-chart="orp">ORP</button>
              </div>
            </div>
            <div class="card__body">
              <div class="chart-container">
                <div class="chart-current-value" id="chart-current-value">
                  <div class="chart-value-label" id="chart-value-label">Température actuelle</div>
                  <div class="chart-value-number" id="chart-value-number">--</div>
                </div>
                <canvas id="mainChart"></canvas>
                <!-- Canvas cachés pour stocker l'historique des données -->
                <canvas id="tempChart" style="display:none;"></canvas>
                <canvas id="phChart" style="display:none;"></canvas>
                <canvas id="orpChart" style="display:none;"></canvas>
              </div>
            </div>
          </div>

          <!-- Sections détaillées -->
          <div class="grid grid--details">
            <!-- Détail Filtration -->
            <div class="card card--detail">
              <div class="card__head">
                <div class="card__title">Filtration</div>
              </div>
              <div class="card__body">
                <div class="detail-row">
                  <div class="detail-label">Mode</div>
                  <div class="detail-value" id="detail-filtration-mode">Auto</div>
                </div>
                <div class="detail-row">
                  <div class="detail-label">Horaires</div>
                  <div class="detail-value" id="detail-filtration-schedule">08:00 - 20:00</div>
                </div>
                <div class="detail-row">
                  <div class="detail-label">État actuel</div>
                  <div class="detail-value">
                    <span class="state-badge state-badge--ok" id="detail-filtration-status">En marche</span>
                  </div>
                </div>
                <div class="detail-actions">
                  <button class="btn btn--primary" id="detail-filtration-start">Démarrer</button>
                  <button class="btn btn--secondary" id="detail-filtration-stop">Arrêter</button>
                  <a href="#/filtration" class="btn btn--link">Configurer</a>
                </div>
              </div>
            </div>

            <!-- Détail Éclairage -->
            <div class="card card--detail">
              <div class="card__head">
                <div class="card__title">Éclairage</div>
              </div>
              <div class="card__body">
                <div class="detail-row">
                  <div class="detail-label">État actuel</div>
                  <div class="detail-value">
                    <span class="state-badge state-badge--off" id="detail-lighting-status">Éteint</span>
                  </div>
                </div>
                <div class="detail-row">
                  <div class="detail-label">Prochain changement</div>
                  <div class="detail-value" id="detail-lighting-next">--:--</div>
                </div>
                <div class="detail-actions">
                  <button class="btn btn--primary" id="detail-lighting-on">Allumer</button>
                  <button class="btn btn--secondary" id="detail-lighting-off">Éteindre</button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Filtration View -->
        <section class="view" id="view-filtration" data-view="/filtration">
          <div class="settingsHead">
            <div class="settingsHead__title">Filtration</div>
            <div class="settingsHead__sub">Configuration de la pompe de filtration</div>
          </div>

          <div class="card">
            <div class="card__head">
              <div class="card__title">Filtration</div>
            </div>
            <div class="card__body">
              <label class="field">
                <span class="field__label">Mode de filtration</span>
                <select id="filtration_mode">
                  <option value="auto">Auto</option>
                  <option value="manual">Manuel</option>
                  <option value="off">Désactivé</option>
                </select>
              </label>

              <div class="grid grid--2">
                <label class="field">
                  <span class="field__label">Début</span>
                  <input type="time" id="filtration_start" value="08:00" />
                </label>

                <label class="field">
                  <span class="field__label">Fin</span>
                  <input type="time" id="filtration_end" value="20:00" />
                </label>
              </div>

              <div class="hint">
                En mode Auto, la durée peut être recalculée automatiquement après un premier cycle.
              </div>
            </div>
          </div>
        </section>

        <!-- Lighting View (placeholder) -->
        <section class="view" id="view-lighting" data-view="/lighting">
          <div class="settingsHead">
            <div class="settingsHead__title">Éclairage</div>
            <div class="settingsHead__sub">Contrôle de l'éclairage de la piscine</div>
          </div>

          <div class="card">
            <div class="card__head">
              <div class="card__title">Éclairage</div>
            </div>
            <div class="card__body">
              <div class="hint">
                Fonctionnalité à venir
              </div>
            </div>
          </div>
        </section>

        <!-- Temperature View -->
        <section class="view" id="view-temperature" data-view="/temperature">
          <div class="settingsHead">
            <div class="settingsHead__title">Température</div>
            <div class="settingsHead__sub">Calibration et surveillance de la température de l'eau</div>
          </div>

          <div class="card">
            <div class="card__head">
              <div class="card__title">Calibration de la température</div>
            </div>
            <div class="card__body">
              <div class="callout callout--success" id="temp_calibrated_status" style="display:none;">
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span style="font-size: 18px;">✓</span>
                  <strong>Calibré</strong>
                  <span style="margin-left: auto;">✓</span>
                </div>
                <div class="muted small" id="temp_cal_date">Dernière calibration : —</div>
              </div>

              <div class="readout">
                <div class="readout__label">Température actuelle</div>
                <div class="readout__value" id="temp_current_value">--</div>
                <div class="readout__sub muted">
                  <span>Brute: <span id="temp_current_raw">--</span></span>
                  <span style="margin-left: 12px;">MAJ auto toutes les 30 secondes</span>
                </div>
              </div>

              <div class="calibration-steps">
                <div class="step" id="temp_step1">
                  <div class="step__number">1</div>
                  <div class="step__content">Plonger la sonde dans un liquide à température connue</div>
                </div>
                <div class="step" id="temp_step2">
                  <div class="step__number">2</div>
                  <div class="step__content">
                    <div>Entrer la température de référence</div>
                    <input type="number" id="temp_reference_value" min="-10" max="50" step="0.1" placeholder="ex: 25.0 °C" style="margin-top: 8px; width: 100%;" />
                  </div>
                </div>
                <div class="step" id="temp_step3">
                  <div class="step__number">3</div>
                  <div class="step__content">Calibrer</div>
                </div>
              </div>

              <div class="row row--gap">
                <button class="btn btn--primary" type="button" id="temp_cal_start_btn">Commencer la calibration</button>
                <button class="btn btn--danger" type="button" id="temp_cal_cancel_btn" style="display:none;">Annuler</button>
              </div>
            </div>
          </div>
        </section>

        <!-- pH View -->
        <section class="view" id="view-ph" data-view="/ph">
          <div class="settingsHead">
            <div class="settingsHead__title">pH</div>
            <div class="settingsHead__sub">Calibration et régulation du pH</div>
          </div>

          <div class="card">
            <div class="card__head">
              <div class="card__title">Régulation pH</div>
            </div>
            <div class="card__body">
              <div class="row row--between">
                <div>
                  <div class="row__title">Activer la régulation</div>
                  <div class="muted small">Auto-save</div>
                </div>
                <label class="switch">
                  <input type="checkbox" id="ph_enabled" />
                  <span class="switch__track"></span>
                </label>
              </div>

              <div class="grid grid--2">
                <label class="field">
                  <span class="field__label">pH cible</span>
                  <input type="number" id="ph_target" min="0" max="14" step="0.1" placeholder="ex: 7.2" />
                </label>

                <label class="field">
                  <span class="field__label">Durée max / heure (s)</span>
                  <input type="number" id="ph_limit" min="0" step="1" value="60" />
                </label>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card__head">
              <div class="card__title">Calibration du pH</div>
            </div>
            <div class="card__body">
              <div class="callout callout--success" id="ph_calibrated_status" style="display:none;">
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span style="font-size: 18px;">✓</span>
                  <strong>Calibré</strong>
                  <span style="margin-left: auto;">✓</span>
                </div>
                <div class="muted small" id="ph_cal_date">Dernière calibration : —</div>
              </div>

              <div class="readout">
                <div class="readout__label">Valeur pH actuelle</div>
                <div class="readout__value" id="ph_current_value">--</div>
                <div class="readout__sub muted">MAJ auto toutes les 30 secondes</div>
              </div>

              <div class="calibration-steps">
                <div class="step" id="ph_step1">
                  <div class="step__number">1</div>
                  <div class="step__content">Plonger dans une solution d'étalonnage pH 7.0</div>
                </div>
                <div class="step" id="ph_step2">
                  <div class="step__number">2</div>
                  <div class="step__content">Calibrer pH 7.0</div>
                </div>
                <div class="step" id="ph_step3">
                  <div class="step__number">3</div>
                  <div class="step__content">Plonger dans une solution d'étalonnage pH 4.0</div>
                </div>
                <div class="step" id="ph_step4">
                  <div class="step__number">4</div>
                  <div class="step__content">Calibrer pH 4.0 (acide)</div>
                </div>
              </div>

              <div class="row row--gap">
                <button class="btn btn--primary" type="button" id="ph_cal_start_btn">Commencer la calibration</button>
                <button class="btn btn--danger" type="button" id="ph_cal_cancel_btn" style="display:none;">Annuler</button>
              </div>
            </div>
          </div>

        </section>

        <!-- ORP View -->
        <section class="view" id="view-orp" data-view="/orp">
          <div class="settingsHead">
            <div class="settingsHead__title">ORP</div>
            <div class="settingsHead__sub">Calibration et régulation du potentiel redox</div>
          </div>

          <div class="card">
            <div class="card__head">
              <div class="card__title">Régulation ORP</div>
            </div>
            <div class="card__body">
              <div class="row row--between">
                <div>
                  <div class="row__title">Activer la régulation</div>
                  <div class="muted small">Auto-save</div>
                </div>
                <label class="switch">
                  <input type="checkbox" id="orp_enabled" />
                  <span class="switch__track"></span>
                </label>
              </div>

              <div class="grid grid--2">
                <label class="field">
                  <span class="field__label">ORP cible (mV)</span>
                  <input type="number" id="orp_target" min="0" max="1000" step="1" placeholder="ex: 650" />
                </label>

                <label class="field">
                  <span class="field__label">Durée max / heure (s)</span>
                  <input type="number" id="orp_limit" min="0" step="1" value="60" />
                </label>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card__head">
              <div class="card__title">Calibration de l'ORP</div>
            </div>
            <div class="card__body">
              <div class="callout callout--success" id="orp_calibrated_status" style="display:none;">
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span style="font-size: 18px;">✓</span>
                  <strong>Calibré</strong>
                  <span style="margin-left: auto;">✓</span>
                </div>
                <div class="muted small" id="orp_cal_date">Dernière calibration : —</div>
              </div>

              <div class="readout">
                <div class="readout__label">Valeur ORP actuelle</div>
                <div class="readout__value" id="orp_current_value">--</div>
                <div class="readout__sub muted">MAJ auto toutes les 30 secondes</div>
              </div>

              <label class="field">
                <span class="field__label">Type de calibration</span>
                <select id="orp_cal_type">
                  <option value="1point">1 point (offset uniquement)</option>
                  <option value="2points">2 points (offset + slope)</option>
                </select>
              </label>

              <!-- Calibration 1 point -->
              <div id="orp_cal_1point">
                <div class="calibration-steps">
                  <div class="step" id="orp_step1_1pt">
                    <div class="step__number">1</div>
                    <div class="step__content">Plonger la sonde dans la solution d'étalonnage ORP</div>
                  </div>
                  <div class="step" id="orp_step2_1pt">
                    <div class="step__number">2</div>
                    <div class="step__content">
                      <div>Entrer la valeur de référence</div>
                      <input type="number" id="orp_reference_value_1pt" min="0" max="1000" step="1" placeholder="ex: 650 mV" style="margin-top: 8px; width: 100%;" />
                    </div>
                  </div>
                  <div class="step" id="orp_step3_1pt">
                    <div class="step__number">3</div>
                    <div class="step__content">Calibrer</div>
                  </div>
                </div>

                <div class="row row--gap">
                  <button class="btn btn--primary" type="button" id="orp_cal_start_btn_1pt">Commencer la calibration</button>
                  <button class="btn btn--danger" type="button" id="orp_cal_cancel_btn_1pt" style="display:none;">Annuler</button>
                </div>
              </div>

              <!-- Calibration 2 points -->
              <div id="orp_cal_2points" style="display:none;">
                <div class="calibration-steps">
                  <div class="step" id="orp_step1_2pt">
                    <div class="step__number">1</div>
                    <div class="step__content">Plonger la sonde dans la solution 1 d'étalonnage ORP</div>
                  </div>
                  <div class="step" id="orp_step2_2pt">
                    <div class="step__number">2</div>
                    <div class="step__content">
                      <div>Entrer la valeur de référence 1</div>
                      <input type="number" id="orp_ref1" min="0" max="1000" step="1" placeholder="ex: 470 mV" style="margin-top: 8px; width: 100%;" />
                    </div>
                  </div>
                  <div class="step" id="orp_step3_2pt">
                    <div class="step__number">3</div>
                    <div class="step__content">Mémoriser le point 1</div>
                  </div>
                  <div class="step" id="orp_step4_2pt">
                    <div class="step__number">4</div>
                    <div class="step__content">Plonger la sonde dans la solution 2 d'étalonnage ORP</div>
                  </div>
                  <div class="step" id="orp_step5_2pt">
                    <div class="step__number">5</div>
                    <div class="step__content">
                      <div>Entrer la valeur de référence 2</div>
                      <input type="number" id="orp_ref2" min="0" max="1000" step="1" placeholder="ex: 650 mV" style="margin-top: 8px; width: 100%;" />
                    </div>
                  </div>
                  <div class="step" id="orp_step6_2pt">
                    <div class="step__number">6</div>
                    <div class="step__content">Calibrer (2 points)</div>
                  </div>
                </div>

                <div class="hint" id="orp_2pt_status" style="display:none; margin-bottom: 12px;">
                  Point 1 mémorisé
                </div>

                <div class="row row--gap">
                  <button class="btn btn--primary" type="button" id="orp_cal_start_btn_2pt">Commencer la calibration</button>
                  <button class="btn btn--danger" type="button" id="orp_cal_cancel_btn_2pt" style="display:none;">Annuler</button>
                </div>
              </div>
            </div>
          </div>

        </section>

        <!-- Dosages View (placeholder) -->
        <section class="view" id="view-dosages" data-view="/dosages">
          <div class="settingsHead">
            <div class="settingsHead__title">Dosages</div>
            <div class="settingsHead__sub">Gestion des dosages et produits chimiques</div>
          </div>

          <div class="card">
            <div class="card__head">
              <div class="card__title">Dosages</div>
            </div>
            <div class="card__body">
              <div class="hint">
                Fonctionnalité à venir
              </div>
            </div>
          </div>
        </section>

        <!-- Settings View -->
        <section class="view" id="view-settings" data-view="/settings">
          <div class="settingsHead">
            <div class="settingsHead__title">Paramètres</div>
            <div class="settingsHead__sub">Configuration système et avancée</div>
          </div>

          <!-- Menu segmenté au-dessus des panels -->
          <div class="segmented" id="settings-segmented">
            <button class="segmented__btn is-active" type="button" data-settings-tab="wifi">Wi-Fi</button>
            <button class="segmented__btn" type="button" data-settings-tab="mqtt">MQTT</button>
            <button class="segmented__btn" type="button" data-settings-tab="time">Heure</button>
            <button class="segmented__btn" type="button" data-settings-tab="security">Sécurité</button>
            <button class="segmented__btn" type="button" data-settings-tab="system">Système</button>
            <button class="segmented__btn" type="button" data-settings-tab="dev">Développement</button>
            <button class="segmented__btn" type="button" data-settings-tab="about">À propos</button>
          </div>

          <div class="settingsPanels">
            <!-- Wi-Fi Panel -->
            <section class="panel is-active" data-settings-panel="wifi">
              <div class="card">
                <div class="card__head">
                  <div class="card__title">Wi-Fi</div>
                </div>
                <div class="card__body">
                  <div class="kv">
                    <div class="kv__row"><span class="kv__k">SSID</span><span class="kv__v" id="wifi_ssid">—</span></div>
                    <div class="kv__row"><span class="kv__k">IP</span><span class="kv__v" id="wifi_ip">—</span></div>
                    <div class="kv__row"><span class="kv__k">Mode</span><span class="kv__v" id="wifi_mode">—</span></div>
                    <div class="kv__row"><span class="kv__k">mDNS</span><span class="kv__v" id="wifi_mdns">—</span></div>
                  </div>

                  <div class="row row--gap" style="margin-top: 16px;">
                    <button class="btn btn--danger" type="button" id="restart_ap_btn">Redémarrer en mode AP</button>
                  </div>
                </div>
              </div>
            </section>

            <!-- MQTT Panel -->
            <section class="panel" data-settings-panel="mqtt">
              <div class="card">
                <div class="card__head">
                  <div class="card__title">
                    MQTT
                    <span class="pill" id="mqtt_status_pill">—</span>
                  </div>
                </div>

                <div class="card__body">
                  <div class="row row--between">
                    <div>
                      <div class="row__title">Activer MQTT</div>
                      <div class="muted small">Auto-save</div>
                    </div>
                    <label class="switch">
                      <input type="checkbox" id="mqtt_enabled" />
                      <span class="switch__track"></span>
                    </label>
                  </div>

                  <div class="grid grid--2">
                    <label class="field">
                      <span class="field__label">Serveur</span>
                      <input type="text" id="mqtt_server" placeholder="ex: 192.168.1.10" />
                    </label>
                    <label class="field">
                      <span class="field__label">Port</span>
                      <input type="number" id="mqtt_port" value="1883" />
                    </label>
                  </div>

                  <label class="field">
                    <span class="field__label">Topic</span>
                    <input type="text" id="mqtt_topic" placeholder="ex: poolcontroller" />
                  </label>

                  <div class="grid grid--2">
                    <label class="field">
                      <span class="field__label">Utilisateur</span>
                      <input type="text" id="mqtt_username" />
                    </label>
                    <label class="field">
                      <span class="field__label">Mot de passe</span>
                      <input type="password" id="mqtt_password" />
                    </label>
                  </div>

                  <div class="hint">
                    Après un changement serveur/identifiants, le statut MQTT peut mettre quelques secondes à se mettre à jour.
                  </div>
                </div>
              </div>
            </section>

            <!-- Time Panel -->
            <section class="panel" data-settings-panel="time">
              <div class="card">
                <div class="card__head">
                  <div class="card__title">Heure</div>
                </div>
                <div class="card__body">
                  <div class="row row--between">
                    <div>
                      <div class="row__title">Utiliser NTP</div>
                      <div class="muted small">Sinon: heure manuelle</div>
                    </div>
                    <label class="switch">
                      <input type="checkbox" id="time_use_ntp" />
                      <span class="switch__track"></span>
                    </label>
                  </div>

                  <label class="field">
                    <span class="field__label">Timezone</span>
                    <select id="time_timezone">
                      <option value="europe_paris">Europe/Paris</option>
                      <option value="utc">UTC</option>
                      <option value="america_new_york">America/New_York</option>
                      <option value="america_los_angeles">America/Los_Angeles</option>
                      <option value="asia_tokyo">Asia/Tokyo</option>
                      <option value="australia_sydney">Australia/Sydney</option>
                    </select>
                  </label>

                  <label class="field">
                    <span class="field__label">Serveur NTP</span>
                    <input type="text" id="time_ntp_server" placeholder="pool.ntp.org" />
                  </label>

                  <label class="field">
                    <span class="field__label">Heure</span>
                    <input type="datetime-local" id="time_value" />
                  </label>
                </div>
              </div>
            </section>

            <!-- Security Panel -->
            <section class="panel" data-settings-panel="security">
              <div class="card">
                <div class="card__head">
                  <div class="card__title">Authentification</div>
                </div>
                <div class="card__body">
                  <label class="field">
                    <span class="field__label">Mot de passe actuel</span>
                    <input type="password" id="auth_current_password" placeholder="Mot de passe actuel" autocomplete="current-password" />
                  </label>

                  <label class="field">
                    <span class="field__label">Nouveau mot de passe</span>
                    <input type="password" id="auth_password" placeholder="Minimum 8 caractères" autocomplete="new-password" />
                  </label>

                  <label class="field">
                    <span class="field__label">Confirmer le mot de passe</span>
                    <input type="password" id="auth_password_confirm" placeholder="Re-tapez le mot de passe" autocomplete="new-password" />
                  </label>

                  <div class="hint">
                    Pour modifier votre mot de passe, saisissez d'abord votre mot de passe actuel, puis le nouveau mot de passe (minimum 8 caractères).
                  </div>

                  <div class="row row--gap" style="margin-top: 16px;">
                    <button class="btn btn--primary" type="button" id="change_password_btn">Modifier le mot de passe</button>
                  </div>
                </div>
              </div>

              <div class="card">
                <div class="card__head">
                  <div class="card__title">CORS (Cross-Origin Resource Sharing)</div>
                </div>
                <div class="card__body">
                  <label class="field">
                    <span class="field__label">Origines autorisées</span>
                    <input type="text" id="auth_cors_origins" placeholder="Vide = désactivé, * = tous, ou liste séparée par virgules" />
                  </label>

                  <div class="hint">
                    <strong>Configuration CORS:</strong>
                    <ul style="margin: 8px 0; padding-left: 20px; list-style: disc;">
                      <li><strong>Vide</strong>: CORS désactivé (recommandé pour usage local uniquement)</li>
                      <li><strong>*</strong>: Accepter toutes les origines (moins sécurisé)</li>
                      <li><strong>Liste blanche</strong>: Ex: <code>http://homeassistant.local:8123,https://exemple.com</code></li>
                    </ul>
                    Nécessite un redémarrage de l'ESP32 pour être appliqué.
                  </div>
                </div>
              </div>
            </section>

            <!-- System Panel -->
            <section class="panel" data-settings-panel="system">
              <div class="card">
                <div class="card__head">
                  <div class="card__title">Version du firmware</div>
                </div>
                <div class="card__body">
                  <div class="kv">
                    <div class="kv__row"><span class="kv__k">Version installée</span><span class="kv__v" id="sys_current_firmware_version">—</span></div>
                  </div>
                </div>
              </div>

              <div class="card">
                <div class="card__head">
                  <div class="card__title">Mise à jour en ligne (GitHub)</div>
                </div>
                <div class="card__body">
                  <div id="github_update_info" class="callout callout--info" style="display:none;">
                    <div><strong>Version actuelle :</strong> <span id="current_version">-</span></div>
                    <div><strong>Dernière version :</strong> <span id="latest_version">-</span></div>

                    <div id="release_info" style="display:none; margin-top:10px;">
                      <div><strong>Release :</strong> <span id="release_name">-</span></div>
                      <div><strong>Date :</strong> <span id="release_date">-</span></div>
                      <div style="margin-top:8px;">
                        <strong>Notes :</strong>
                        <pre id="release_notes" class="pre">-</pre>
                      </div>
                    </div>

                    <div id="update_available_msg" class="badgeLine" style="display:none;">⚡ Mise à jour disponible</div>
                    <div id="no_update_msg" class="badgeLine" style="display:none;">✓ À jour</div>
                  </div>

                  <div id="github_update_progress" style="display:none;">
                    <div class="progress">
                      <div class="progress__bar" id="github_update_progress_bar">0%</div>
                    </div>
                    <div class="muted small" id="github_update_status">Téléchargement...</div>
                  </div>

                  <div class="row row--gap">
                    <button class="btn" type="button" id="check_update_btn">Vérifier</button>
                    <button class="btn btn--ok" type="button" id="install_update_btn" disabled>Mettre à jour</button>
                  </div>
                </div>
              </div>

              <div class="card">
                <div class="card__head">
                  <div class="card__title">Mise à jour manuelle</div>
                </div>
                <div class="card__body">
                  <label class="field">
                    <span class="field__label">Type</span>
                    <select id="update_type">
                      <option value="firmware">Firmware (.bin)</option>
                      <option value="filesystem">Système de fichiers (.bin)</option>
                    </select>
                  </label>

                  <label class="field">
                    <span class="field__label">Fichier</span>
                    <input type="file" id="update_file" accept=".bin" />
                  </label>

                  <div id="update_progress" style="display:none;">
                    <div class="progress">
                      <div class="progress__bar" id="update_progress_bar">0%</div>
                    </div>
                    <div class="muted small" id="update_status">Préparation…</div>
                  </div>

                  <div class="row row--gap">
                    <button class="btn btn--ok" type="button" id="update_btn" disabled>Mettre à jour</button>
                  </div>
                </div>
              </div>

              <div class="card">
                <div class="card__head">
                  <div class="card__title">Redémarrage</div>
                </div>
                <div class="card__body">
                  <div class="hint">
                    Redémarrer pour appliquer certaines modifications (CORS, etc.) ou résoudre des problèmes.
                  </div>

                  <div class="row row--gap" style="margin-top: 16px;">
                    <button class="btn btn--danger" type="button" id="reboot_btn">Redémarrer</button>
                  </div>
                </div>
              </div>
            </section>

            <!-- Development Panel -->
            <section class="panel" data-settings-panel="dev">
              <div class="card">
                <div class="card__head">
                  <div class="card__title">Configuration pompes</div>
                </div>
                <div class="card__body">
                  <div class="grid grid--2">
                    <label class="field">
                      <span class="field__label">Pompe pH</span>
                      <select id="ph_pump">
                        <option value="1">Pompe 1</option>
                        <option value="2">Pompe 2</option>
                      </select>
                    </label>

                    <label class="field">
                      <span class="field__label">Pompe ORP</span>
                      <select id="orp_pump">
                        <option value="1">Pompe 1</option>
                        <option value="2">Pompe 2</option>
                      </select>
                    </label>
                  </div>

                  <div class="hint">
                    Configuration des pompes doseuses pour la régulation pH et ORP. Auto-save.
                  </div>
                </div>
              </div>

              <div class="card">
                <div class="card__head">
                  <div class="card__title">Test des pompes</div>
                </div>
                <div class="card__body">
                  <div class="pump">
                    <div class="row row--between">
                      <div>
                        <div class="row__title">Pompe 1</div>
                        <div class="muted small">
                          Puissance: <span id="pump1_duty_value">100</span>% (PWM <span id="pump1_duty_pwm">255</span>/255)
                        </div>
                      </div>
                      <label class="switch">
                        <input type="checkbox" id="pump1_test" />
                        <span class="switch__track"></span>
                      </label>
                    </div>
                    <input type="range" id="pump1_duty" min="0" max="255" value="255" />
                  </div>

                  <div class="pump">
                    <div class="row row--between">
                      <div>
                        <div class="row__title">Pompe 2</div>
                        <div class="muted small">
                          Puissance: <span id="pump2_duty_value">100</span>% (PWM <span id="pump2_duty_pwm">255</span>/255)
                        </div>
                      </div>
                      <label class="switch">
                        <input type="checkbox" id="pump2_test" />
                        <span class="switch__track"></span>
                      </label>
                    </div>
                    <input type="range" id="pump2_duty" min="0" max="255" value="255" />
                  </div>
                </div>
              </div>

              <div class="card">
                <div class="card__head">
                  <div class="card__title">Infos système</div>
                </div>
                <div class="card__body">
                  <div class="kv">
                    <div class="kv__row"><span class="kv__k">Firmware</span><span class="kv__v" id="sys_firmware_version">—</span></div>
                    <div class="kv__row"><span class="kv__k">Build</span><span class="kv__v" id="sys_build_date">—</span></div>
                    <div class="kv__row"><span class="kv__k">Uptime</span><span class="kv__v" id="sys_uptime">—</span></div>
                    <div class="kv__row"><span class="kv__k">Chip</span><span class="kv__v" id="sys_chip_model">—</span></div>
                    <div class="kv__row"><span class="kv__k">CPU</span><span class="kv__v" id="sys_cpu_freq">—</span></div>
                    <div class="kv__row"><span class="kv__k">Heap libre</span><span class="kv__v" id="sys_free_heap">—</span></div>
                    <div class="kv__row"><span class="kv__k">Flash</span><span class="kv__v" id="sys_flash_size">—</span></div>
                    <div class="kv__row"><span class="kv__k">FS</span><span class="kv__v" id="sys_fs_usage">—</span></div>
                    <div class="kv__row"><span class="kv__k">Wi-Fi RSSI</span><span class="kv__v" id="sys_wifi_rssi">—</span></div>
                    <div class="kv__row"><span class="kv__k">MAC</span><span class="kv__v" id="sys_mac_address">—</span></div>
                  </div>

                  <div class="row row--gap">
                    <button class="btn btn--ghost" type="button" id="refresh_info_btn">Actualiser</button>
                  </div>
                </div>
              </div>

              <div class="card">
                <div class="card__head">
                  <div class="card__title">Logs</div>
                </div>
                <div class="card__body">
                  <div class="row row--gap row--between">
                    <div class="row row--gap">
                      <button class="btn btn--ghost" type="button" id="refresh_logs_btn">Actualiser</button>
                      <button class="btn btn--ghost" type="button" id="clear_logs_display_btn">Effacer</button>
                      <label class="field field--inline" style="margin: 0;">
                        <input type="checkbox" id="logs_auto_refresh" />
                        <span class="field__label">Auto-refresh (2s)</span>
                      </label>
                    </div>

                    <label class="field field--inline">
                      <span class="field__label">Filtre</span>
                      <select id="logs_filter">
                        <option value="all">Tout</option>
                        <option value="temp">Temp</option>
                        <option value="ph">pH</option>
                        <option value="orp">ORP</option>
                      </select>
                    </label>
                  </div>

                  <div class="terminal" id="logs_container">
                    <div id="logs_content">Chargement…</div>
                  </div>
                </div>
              </div>
            </section>

            <!-- About Panel -->
            <section class="panel" data-settings-panel="about">
              <div class="card">
                <div class="card__head">
                  <div class="card__title">À propos</div>
                </div>
                <div class="card__body">
                  <div class="hint">
                    Contrôleur de piscine ESP32 avec régulation pH/ORP automatique.
                  </div>

                  <div style="margin-top: 24px;">
                    <strong>Projet:</strong>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><a href="https://github.com/niko34/esp32-pool-controller" target="_blank">esp32-pool-controller</a></li>
                      <li>Auteur: Nicolas Philippe</li>
                    </ul>
                  </div>

                  <div style="margin-top: 16px;">
                    <strong>Interface utilisateur:</strong>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li>SPA vanilla JavaScript (app.js, app.css, index.html)</li>
                      <li><a href="https://github.com/chartjs/Chart.js" target="_blank">Chart.js</a> - Visualisation des données</li>
                    </ul>
                  </div>

                  <div style="margin-top: 16px;">
                    <strong>Librairies Backend (ESP32):</strong>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li><a href="https://github.com/me-no-dev/AsyncTCP" target="_blank">AsyncTCP</a> - Gestion TCP asynchrone</li>
                      <li><a href="https://github.com/me-no-dev/ESPAsyncWebServer" target="_blank">ESPAsyncWebServer</a> - Serveur web asynchrone</li>
                      <li><a href="https://github.com/alanswx/ESPAsyncWiFiManager" target="_blank">ESPAsyncWiFiManager</a> - Configuration WiFi</li>
                      <li><a href="https://github.com/bblanchon/ArduinoJson" target="_blank">ArduinoJson v7</a> - Sérialisation JSON</li>
                      <li><a href="https://github.com/knolleary/pubsubclient" target="_blank">PubSubClient v2.8</a> - Client MQTT</li>
                      <li><a href="https://github.com/DFRobot/DFRobot_PH" target="_blank">DFRobot_PH</a> - Capteur pH avec calibration</li>
                      <li><a href="https://github.com/adafruit/Adafruit_ADS1X15" target="_blank">Adafruit ADS1X15 v2.5</a> - Convertisseur ADC</li>
                      <li><a href="https://github.com/milesburton/Arduino-Temperature-Control-Library" target="_blank">DallasTemperature v3.11</a> - Capteur de température</li>
                      <li><a href="https://github.com/PaulStoffregen/OneWire" target="_blank">OneWire v2.3.8</a> - Protocole 1-Wire</li>
                    </ul>
                  </div>

                  <div style="margin-top: 16px;">
                    <strong>Matériel:</strong>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                      <li>ESP32 Dev Board</li>
                      <li>MOSFET IRLZ44N - Contrôle PWM pompes</li>
                      <li>Capteurs pH et ORP (Redox)</li>
                      <li>DS18B20 - Température</li>
                      <li>Relais pour filtration et éclairage</li>
                    </ul>
                  </div>
                </div>
              </div>
            </section>
          </div>
        </section>

        <footer class="footer">
          <span class="muted small">PoolController • UI locale</span>
        </footer>
      </main>
    </div>
  </body>
</html>
